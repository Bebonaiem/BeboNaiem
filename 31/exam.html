<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>واجهة اختبار متقدمة - ميزات محسنة</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="icon" href="logo.png" type="image/x-icon">
    <style>
        :root {
            --primary-color-dark: #00aaff;
            --primary-hover-dark: #0088cc;
            --secondary-color-dark: #8e8e93;
            --success-color-dark: #30d158;
            --success-gradient-end-dark: #60eda8;
            --danger-color-dark: #ff453a;
            --warning-color-dark: #ff9f0a;
            --app-bg-dark: #000000;
            --card-bg-dark: #1c1c1e;
            --element-bg-dark: #2c2c2e;
            --element-hover-bg-dark: #3a3a3c;
            --border-color-dark: #38383a;
            --text-primary-dark: #ffffff;
            --text-secondary-dark: #a0a0b0;
            --text-on-primary-button-dark: #ffffff;
            --text-on-dark-element-dark: #ffffff;

            --primary-color-light: #007aff;
            --primary-hover-light: #005bb5;
            --secondary-color-light: #a0a0b0;
            --success-color-light: #28a745;
            --success-gradient-end-light: #50c16f;
            --danger-color-light: #dc3545;
            --warning-color-light: #ffc107;
            --app-bg-light: #f4f4f8;
            --card-bg-light: #ffffff;
            --element-bg-light: #e9ecef;
            --element-hover-bg-light: #d6dbe0;
            --border-color-light: #ced4da;
            --text-primary-light: #212529;
            --text-secondary-light: #6c757d;
            --text-on-primary-button-light: #ffffff;
            --text-on-dark-element-light: #212529; /* Text on light elements */


            /* Default to dark theme variables */
            --primary-color: var(--primary-color-dark);
            --primary-hover: var(--primary-hover-dark);
            --secondary-color: var(--secondary-color-dark);
            --success-color: var(--success-color-dark);
            --success-gradient-end: var(--success-gradient-end-dark);
            --danger-color: var(--danger-color-dark);
            --warning-color: var(--warning-color-dark);
            --app-bg: var(--app-bg-dark);
            --card-bg: var(--card-bg-dark);
            --element-bg: var(--element-bg-dark);
            --element-hover-bg: var(--element-hover-bg-dark);
            --border-color: var(--border-color-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --text-on-primary-button: var(--text-on-primary-button-dark);
            --text-on-dark-element: var(--text-on-dark-element-dark);


            --font-family: 'Tajawal', sans-serif;
            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --box-shadow-soft: 0 4px 15px rgba(0, 0, 0, 0.1); /* Softer shadow for light theme */
            --box-shadow-strong: 0 6px 20px rgba(0, 0, 0, 0.15); /* Softer shadow for light theme */
            --transition-smooth: all 0.3s ease-in-out;
        }
        
        body.dark-theme {
            --primary-color: var(--primary-color-dark);
            --primary-hover: var(--primary-hover-dark);
            --secondary-color: var(--secondary-color-dark);
            --success-color: var(--success-color-dark);
            --success-gradient-end: var(--success-gradient-end-dark);
            --danger-color: var(--danger-color-dark);
            --warning-color: var(--warning-color-dark);
            --app-bg: var(--app-bg-dark);
            --card-bg: var(--card-bg-dark);
            --element-bg: var(--element-bg-dark);
            --element-hover-bg: var(--element-hover-bg-dark);
            --border-color: var(--border-color-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --text-on-primary-button: var(--text-on-primary-button-dark);
            --text-on-dark-element: var(--text-on-dark-element-dark);
            --box-shadow-soft: 0 4px 15px rgba(0, 0, 0, 0.3);
            --box-shadow-strong: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        body.light-theme {
            --primary-color: var(--primary-color-light);
            --primary-hover: var(--primary-hover-light);
            --secondary-color: var(--secondary-color-light);
            --success-color: var(--success-color-light);
            --success-gradient-end: var(--success-gradient-end-light);
            --danger-color: var(--danger-color-light);
            --warning-color: var(--warning-color-light);
            --app-bg: var(--app-bg-light);
            --card-bg: var(--card-bg-light);
            --element-bg: var(--element-bg-light);
            --element-hover-bg: var(--element-hover-bg-light);
            --border-color: var(--border-color-light);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --text-on-primary-button: var(--text-on-primary-button-light);
            --text-on-dark-element: var(--text-on-dark-element-light);
            --box-shadow-soft: 0 4px 15px rgba(0, 0, 0, 0.1);
            --box-shadow-strong: 0 6px 20px rgba(0, 0, 0, 0.15);
        }


        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-family);
            line-height: 1.7;
            background-color: var(--app-bg);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            transition: var(--transition-smooth);
        }

        .landing-container {
            background-color: var(--card-bg);
            padding: 40px 50px;
            border-radius: var(--border-radius-md);
            box-shadow: var(--box-shadow-strong);
            text-align: center;
            max-width: 650px;
            width: 100%;
            opacity: 0;
            transform: translateY(20px);
        }

        .landing-container .icon-wrapper {
            font-size: 3.5em;
            color: var(--primary-color);
            margin-bottom: 20px;
            line-height: 1;
        }
        .landing-container .icon-wrapper i {
            animation: pulseIcon 2.5s infinite ease-in-out;
        }

        .landing-container h1 {
            color: var(--primary-color);
            font-size: 2.4em;
            font-weight: 800;
            margin-bottom: 15px;
        }
        .landing-container p {
            font-size: 1.15em;
            color: var(--text-secondary);
            margin-bottom: 25px;
            line-height: 1.8;
        }
        .start-exam-btn, .secondary-btn {
            color: var(--text-on-primary-button);
            border: none;
            padding: 14px 30px; /* Adjusted padding */
            font-size: 1.15em; /* Adjusted font size */
            font-weight: 700;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: var(--transition-smooth), transform 0.1s ease;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 5px; /* Added margin */
        }
        .start-exam-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            box-shadow: 0 3px 8px rgba(var(--primary-color-rgb, 0,170,255), 0.3); /* Use RGB for dynamic alpha */
        }
        body.light-theme .start-exam-btn {
             box-shadow: 0 3px 8px rgba(0,122,255, 0.3);
        }
       
        .start-exam-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 18px rgba(var(--primary-color-rgb, 0,170,255), 0.45);
        }
         body.light-theme .start-exam-btn:hover {
             box-shadow: 0 6px 18px rgba(0,122,255, 0.45);
        }
        .start-exam-btn:active {
            transform: translateY(-1px) scale(1);
        }

        .secondary-btn {
            background-color: var(--element-bg);
            color: var(--text-primary); /* Adjusted for better visibility on element-bg */
            border: 1px solid var(--border-color);
            padding: 12px 25px; /* Adjusted padding */
            font-size: 1.05em; /* Adjusted font size */
        }
        .secondary-btn:hover:not(:disabled) {
            background-color: var(--element-hover-bg);
            color: var(--text-primary);
            border-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        .secondary-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loft-exam-container, .old-results-container {
            width: 100%;
            max-width: 800px; /* Increased max-width */
            background-color: var(--card-bg);
            border-radius: var(--border-radius-md);
            box-shadow: var(--box-shadow-strong);
            overflow: hidden;
            display: none;
            opacity: 0;
        }
         .old-results-container {
            margin-top: 30px;
        }

        .exam-header {
            background-color: var(--primary-color);
            color: var(--text-on-primary-button);
            padding: 15px 25px; /* Adjusted padding */
            text-align: center;
            border-bottom: 3px solid var(--primary-hover);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .exam-header h1 {
            font-size: 1.6em; /* Adjusted font size */
            font-weight: 700;
            margin: 0;
            letter-spacing: 0.5px;
            flex-grow: 1;
            text-align: center; /* Center title */
        }
        .theme-toggle-btn {
            background: none;
            border: none;
            color: var(--text-on-primary-button);
            font-size: 1.4em;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s ease;
        }
        .theme-toggle-btn:hover {
            transform: scale(1.1);
        }


        .progress-indicator {
            padding: 10px 20px; /* Adjusted padding */
            background-color: var(--element-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            gap: 10px; /* Adjusted gap */
        }
        .progress-text {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.9em; /* Adjusted font size */
            flex-shrink: 0;
        }
        .timer-display {
            font-weight: 700;
            font-size: 1em; /* Adjusted font size */
            color: var(--warning-color);
            background-color: rgba(var(--warning-color-rgb, 255,159,10), 0.1);
            padding: 4px 8px; /* Adjusted padding */
            border-radius: var(--border-radius-sm);
            min-width: 60px; /* Adjusted width */
            text-align: center;
        }
         body.light-theme .timer-display {
             background-color: rgba(255,193,7, 0.15);
        }
        .progress-bar-shell {
            width: 40%; /* Adjusted width */
            height: 8px; /* Adjusted height */
            background-color: var(--border-color);
            border-radius: var(--border-radius-sm);
            overflow: hidden;
        }
        .progress-bar-fill {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), var(--success-gradient-end)); 
            border-radius: var(--border-radius-sm);
            transition: width 0.4s ease-out;
        }
        .question-nav-toggle-btn {
            background-color: var(--element-hover-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            font-size: 0.9em;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
        }
        .question-nav-toggle-btn:hover {
            background-color: var(--secondary-color);
        }

        .question-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .flag-question-btn {
            background: none;
            border: 1px solid var(--secondary-color);
            color: var(--secondary-color);
            padding: 8px 15px;
            font-size: 0.9em;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition-smooth);
        }
        .flag-question-btn.flagged {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
            color: var(--app-bg); /* Text color on warning background */
        }
        body.light-theme .flag-question-btn.flagged {
            color: var(--text-primary-light);
        }
        .flag-question-btn i { margin-left: 5px; }


        .question-display-area {
            padding: 25px; /* Adjusted padding */
            min-height: 250px; /* Adjusted height */
        }

        .question-card-loft {
            background-color: transparent;
            padding: 0;
            opacity: 0;
            transform: translateX(30px); 
        }
        .question-statement {
            font-weight: 700;
            font-size: 1.25em; /* Adjusted font size */
            margin-bottom: 20px; /* Adjusted margin */
            color: var(--text-primary);
            line-height: 1.6;
        }
        .options-list { display: flex; flex-direction: column; gap: 12px; } /* Adjusted gap */
        .option-item label {
            display: flex;
            align-items: center;
            padding: 12px 18px; /* Adjusted padding */
            background-color: var(--element-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition-smooth), box-shadow 0.2s ease;
            color: var(--text-on-dark-element);
            font-size: 1em; /* Adjusted font size */
        }
        .option-item label:hover {
            background-color: var(--element-hover-bg);
            border-color: var(--primary-color);
            transform: translateX(5px); 
            box-shadow: 0 0 10px rgba(var(--primary-color-rgb,0,170,255), 0.3); 
        }
         body.light-theme .option-item label:hover {
             box-shadow: 0 0 10px rgba(0,122,255, 0.3);
        }

        .option-item input[type="radio"] {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 18px; /* Adjusted size */
            height: 18px; /* Adjusted size */
            border: 2px solid var(--text-secondary);
            border-radius: 50%;
            outline: none;
            cursor: pointer;
            transition: var(--transition-smooth);
            position: relative;
            vertical-align: middle;
            margin-left: 12px; /* Adjusted margin */
        }
        .option-item input[type="radio"]:checked {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
        }
        .option-item input[type="radio"]:checked::before {
            content: '';
            display: block;
            width: 8px; /* Adjusted size */
            height: 8px; /* Adjusted size */
            background-color: var(--card-bg); 
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .option-item input[type="radio"]:focus-visible {
            box-shadow: 0 0 0 3px var(--primary-hover);
        }
        .option-item input[type="radio"]:checked + span {
            color: var(--primary-color);
            font-weight: 700;
            text-shadow: 0 0 5px rgba(var(--primary-color-rgb,0,170,255), 0.4); 
        }
         body.light-theme .option-item input[type="radio"]:checked + span {
             text-shadow: 0 0 5px rgba(0,122,255, 0.4);
        }


        .navigation-controls {
            padding: 20px; /* Adjusted padding */
            background-color: var(--element-bg);
            border-top: 1px solid var(--border-color);
            display: flex; 
            justify-content: center; 
            gap: 12px; /* Adjusted gap */
        }
        .nav-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: var(--text-on-primary-button);
            border: none;
            padding: 10px 25px; /* Adjusted padding */
            font-size: 1em; /* Adjusted font size */
            font-weight: 700;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition-smooth), transform 0.1s ease;
            box-shadow: 0 2px 6px rgba(var(--primary-color-rgb,0,170,255), 0.25);
            min-width: 160px; /* Adjusted width */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        body.light-theme .nav-btn {
             box-shadow: 0 2px 6px rgba(0,122,255, 0.25);
        }
        .icon-before-text { margin-left: 8px; font-size: 0.9em; } 
        .icon-after-text { margin-right: 8px; font-size: 0.9em; } 

        .nav-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 5px 15px rgba(var(--primary-color-rgb,0,170,255), 0.4); 
        }
         body.light-theme .nav-btn:hover {
             box-shadow: 0 5px 15px rgba(0,122,255, 0.4);
        }
        .nav-btn:active { transform: translateY(0px) scale(1); }
        .nav-btn:disabled {
            background: var(--secondary-color);
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.6; /* Slightly more visible */
            color: var(--text-primary); 
        }
        .nav-btn.btn-secondary-style {
            background: var(--secondary-color);
            color: var(--text-primary); /* Ensure text is primary on secondary button */
        }
        .nav-btn.btn-secondary-style:hover:not(:disabled) {
             background: var(--element-hover-bg); 
             box-shadow: 0 4px 12px rgba(var(--secondary-color-rgb,142,142,147), 0.3);
        }
         body.light-theme .nav-btn.btn-secondary-style:hover:not(:disabled) {
             box-shadow: 0 4px 12px rgba(160,160,176, 0.3);
         }
         .nav-btn.btn-secondary-style:disabled {
            background: var(--border-color); 
            color: var(--text-secondary);
         }

        .results-area {
            padding: 25px; /* Adjusted padding */
            text-align: center;
        }
        .results-area.visible, .old-results-container .results-area.visible { 
            opacity: 0; 
            transform: translateY(20px); 
            animation: fadeInSlideUp 0.5s ease-out forwards;
        }
        .results-area h2 {
            color: var(--primary-color);
            font-size: 1.8em; /* Adjusted font size */
            font-weight: 800;
            margin-bottom: 18px; /* Adjusted margin */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .results-area h2 i { margin-left: 10px; } 

        .score-display {
            font-size: 1.6em; /* Adjusted font size */
            font-weight: 800;
            padding: 18px; /* Adjusted padding */
            border-radius: var(--border-radius-md);
            margin-bottom: 20px; /* Adjusted margin */
            transition: var(--transition-smooth);
            display: flex; 
            align-items: center;
            justify-content: center;
        }
        .score-display i { margin-left: 8px; font-size: 1em; } 

        .detailed-feedback-header {
            font-size: 1.2em; /* Adjusted font size */
            color: var(--text-secondary);
            margin-bottom: 12px; /* Adjusted margin */
            font-weight: 700;
        }
        .detailed-feedback {
            text-align: right;
            max-height: 300px; /* Adjusted height */
            overflow-y: auto;
            border: 1px solid var(--border-color);
            padding: 15px; /* Adjusted padding */
            border-radius: var(--border-radius-sm);
            background-color: var(--element-bg);
        }
        .feedback-item {
            padding: 10px 12px; /* Adjusted padding */
            margin-bottom: 8px; /* Adjusted margin */
            border-radius: var(--border-radius-sm);
            border-left-width: 4px; /* Adjusted border */
            border-left-style: solid;
            transition: var(--transition-smooth);
        }
        .feedback-item:hover {
            transform: scale(1.015); /* Adjusted scale */
            box-shadow: var(--box-shadow-soft);
        }
        .feedback-item.correct { background-color: rgba(var(--success-color-rgb,48,209,88), 0.15); border-left-color: var(--success-color); }
        .feedback-item.incorrect { background-color: rgba(var(--danger-color-rgb,255,69,58), 0.15); border-left-color: var(--danger-color); }
        body.light-theme .feedback-item.correct { background-color: rgba(40,167,69, 0.1); }
        body.light-theme .feedback-item.incorrect { background-color: rgba(220,53,69, 0.1); }

        .feedback-item p { margin-bottom: 5px; font-size: 0.95em; color: var(--text-primary); } 
        .feedback-item .user-answer { font-style: italic; color: var(--text-secondary); }
        .feedback-item .correct-answer-text { color: var(--success-color); font-weight: 700; }
        .feedback-item.incorrect .user-answer { color: var(--danger-color); }
        .feedback-item .explanation {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border-color);
            font-size: 0.9em;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        .feedback-item .explanation strong { color: var(--primary-color); }


        /* Question Navigation Modal */
        .q-nav-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            animation: fadeInModal 0.3s ease-out;
        }
        .q-nav-modal-content {
            background-color: var(--card-bg);
            margin: 10% auto;
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            width: 90%;
            max-width: 600px;
            box-shadow: var(--box-shadow-strong);
            position: relative;
        }
        .q-nav-modal-close {
            color: var(--text-secondary);
            position: absolute;
            top: 10px;
            left: 20px; /* RTL support */
            font-size: 2em;
            font-weight: bold;
            cursor: pointer;
        }
        .q-nav-modal-close:hover,
        .q-nav-modal-close:focus {
            color: var(--primary-color);
            text-decoration: none;
        }
        .q-nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .q-nav-item {
            padding: 10px;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition-smooth);
            font-weight: 500;
            background-color: var(--element-bg);
            color: var(--text-on-dark-element);
        }
        .q-nav-item:hover {
            background-color: var(--element-hover-bg);
            border-color: var(--primary-color);
        }
        .q-nav-item.answered {
            background-color: var(--success-color);
            color: var(--text-on-primary-button);
            border-color: var(--success-color);
        }
        body.light-theme .q-nav-item.answered {
             background-color: var(--success-color-light);
             color: #fff;
        }
        .q-nav-item.current {
            background-color: var(--primary-color);
            color: var(--text-on-primary-button);
            border-color: var(--primary-color);
            font-weight: bold;
            transform: scale(1.05);
        }
         body.light-theme .q-nav-item.current {
             background-color: var(--primary-color-light);
             color: #fff;
        }
        .q-nav-item.flagged {
            border-right-width: 5px; /* RTL */
            border-right-color: var(--warning-color);
            padding-right: 7px;
        }
         body.light-theme .q-nav-item.flagged {
             border-right-color: var(--warning-color-light);
        }


        @media (max-width: 700px) {
            body { padding: 10px; }
            .landing-container { padding: 25px 20px; }
            .landing-container h1 { font-size: 1.8em; }
            .landing-container p { font-size: 1em; }
            .start-exam-btn, .secondary-btn { font-size: 1em; padding: 10px 20px; }

            .exam-header h1 { font-size: 1.3em; }
            .progress-indicator { flex-direction: column; gap: 8px; padding: 10px 15px; }
            .progress-bar-shell { width: 100%; }
            .question-statement { font-size: 1.1em; }
            .loft-exam-container, .old-results-container { margin: 0; border-radius: 0; width: 100%; max-width: 100%;}
            .question-display-area, .navigation-controls, .results-area { padding: 15px; }
            .option-item label { padding: 10px 12px; font-size: 0.95em; }
            .navigation-controls { flex-direction: column; } 
            .q-nav-modal-content { width: 95%; margin: 5% auto; }
            .q-nav-grid { grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); }
        }

        @keyframes fadeInSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOutSlideUp {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
        @keyframes fadeInScaleUp {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes questionEntry {
            from { opacity: 0; transform: translateX(30px); } 
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes questionExit {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(-30px); } 
        }
        .question-card-loft.entering { animation: questionEntry 0.4s ease-out forwards; }
        .question-card-loft.exiting { animation: questionExit 0.3s ease-in forwards; }

        @keyframes pulseIcon { 
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @keyframes fadeInModal {
            from { opacity: 0; }
            to { opacity: 1; }
        }

    </style>
</head>
<body class="dark-theme"> <!-- Default to dark theme -->

    <div class="landing-container" id="landingPage">
        <div class="icon-wrapper"><i class="fas fa-user-graduate"></i></div>
        <h1>اختبار في طرق التدريس</h1>
        <p>
            مرحباً بك! هذا الاختبار التفاعلي مصمم لاختبار معرفتك. يتكون من <span id="totalQuestionsLanding"></span> سؤال متنوع. لديك <span id="examDurationLanding">45</span> دقيقة لإكمال الاختبار.
            سيتم عرض الأسئلة سؤالاً تلو الآخر. نتمنى لك كل التوفيق!
        </p>
        <button class="start-exam-btn" onclick="startExam(false)" aria-label="ابدأ الاختبار بالترتيب الافتراضي">
            <i class="fas fa-rocket icon-before-text"></i> ابدأ الاختبار الآن
        </button>
        <button class="start-exam-btn" onclick="startExam(true)" aria-label="ابدأ الاختبار بترتيب عشوائي للأسئلة" style="background: linear-gradient(135deg, var(--success-color), var(--success-gradient-end));">
            <i class="fas fa-random icon-before-text"></i> ابدأ بترتيب عشوائي
        </button>
        <button class="secondary-btn" id="viewLastResultsBtn" onclick="viewLastResults()" style="margin-top: 10px;" disabled>
            <i class="fas fa-history icon-before-text"></i> عرض نتائج آخر اختبار
        </button>
    </div>

    <div class="loft-exam-container" id="examPage">
        <header class="exam-header">
             <button id="themeToggleBtn" class="theme-toggle-btn" onclick="toggleTheme()" aria-label="تبديل الوضع المظلم/المضيء">
                <i class="fas fa-moon"></i> <!-- Icon changes in JS -->
            </button>
            <h1>اختبار خطي فوري</h1>
            <div></div> <!-- Placeholder for balance if needed -->
        </header>

        <div class="progress-indicator" role="toolbar">
            <button id="qNavToggleBtn" class="question-nav-toggle-btn" onclick="toggleQuestionNavModal()" aria-label="عرض قائمة الأسئلة">
                <i class="fas fa-list-ul"></i> عرض الأسئلة
            </button>
            <span class="progress-text" id="progressInfoText" aria-live="polite">السؤال 0 من 0</span>
            <div class="timer-display" id="timerDisplay" aria-live="off">45:00</div>
            <div class="progress-bar-shell" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-labelledby="progressInfoText">
                <div class="progress-bar-fill" id="progressBarFill" style="width: 0%;"></div>
            </div>
        </div>

        <main class="question-display-area" id="questionDisplayArea">
            <!-- Current question will be rendered here -->
        </main>

        <div class="results-area" id="resultsArea" style="display: none;">
            <h2><i class="fas fa-award"></i> نتائج الاختبار</h2>
            <div class="score-display" id="scoreContainer"></div>
            <h3 class="detailed-feedback-header">مراجعة الإجابات:</h3>
            <div class="detailed-feedback" id="detailedFeedbackContainer"></div>
             <button class="nav-btn btn-secondary-style" onclick="restartExam()" style="margin-top: 20px;">
                <i class="fas fa-redo-alt icon-before-text" ></i> إعادة الاختبار
            </button>
        </div>

        <footer class="navigation-controls" id="navigationControls" role="navigation">
            <button class="nav-btn" id="prevBtn" onclick="handlePreviousQuestion()" disabled aria-label="السؤال السابق">
                <i class="fas fa-chevron-right icon-before-text"></i> السؤال السابق
            </button>
            <button class="nav-btn" id="nextBtn" onclick="handleNextQuestion()" disabled aria-label="السؤال التالي">
                السؤال التالي <i class="fas fa-chevron-left icon-after-text"></i>
            </button>
        </footer>
    </div>

    <div class="old-results-container" id="oldResultsPage" style="display: none;">
        <header class="exam-header">
             <button id="themeToggleBtnOldResults" class="theme-toggle-btn" onclick="toggleTheme()" aria-label="تبديل الوضع المظلم/المضيء">
                <i class="fas fa-moon"></i>
            </button>
            <h1>نتائج الاختبار السابق</h1>
             <div></div>
        </header>
        <div class="results-area visible" id="oldResultsDisplayArea">
            <div class="score-display" id="oldScoreContainer"></div>
            <h3 class="detailed-feedback-header">مراجعة الإجابات:</h3>
            <div class="detailed-feedback" id="oldDetailedFeedbackContainer"></div>
            <button class="nav-btn btn-secondary-style" onclick="closeOldResults()" style="margin-top: 20px;">
                <i class="fas fa-times-circle icon-before-text"></i> إغلاق
            </button>
        </div>
    </div>

    <!-- Question Navigation Modal -->
    <div id="questionNavModal" class="q-nav-modal">
        <div class="q-nav-modal-content">
            <span class="q-nav-modal-close" onclick="toggleQuestionNavModal()" aria-label="إغلاق قائمة الأسئلة">×</span>
            <h2>قائمة الأسئلة</h2>
            <div id="qNavGridContainer" class="q-nav-grid">
                <!-- Navigation items will be injected here -->
            </div>
        </div>
    </div>


    <script>
        // --- Questions Start ---
        const allQuestions = [
            // --- True/False Questions ---
            { type: "tf", id: "tf_qq_1", text: "أسلوب التدريس هو طريقة من طرق التدريس التي يتبعها المعلم", answer: false, explanation: "أسلوب التدريس هو الكيفية التي يتناول بها المعلم طريقة التدريس أثناء قيامه بعملية التدريس، وهو يرتبط بالخصائص الشخصية للمعلم." },
            { type: "tf", id: "tf_qq_2", text: "الأهداف السلوكية هى أهداف تصف ما يقوم به المعلم", answer: false, explanation: "الأهداف السلوكية تصف الأداء المتوقع من المتعلم بعد مروره بخبرة تعليمية معينة." },
            { type: "tf", id: "tf_qq_3", text: "يركز المجال الوجداني للأهداف على القيم والإتجاهات والميول التي يجب أن يكتسبها المتعلمين", answer: true, explanation: "المجال الوجداني يتعلق بالمشاعر والقيم والاتجاهات والميول، مثل التقدير والاهتمام." },
            { type: "tf", id: "tf_qq_4", text: "التعلم التعاوني هو طريقة تقليدية في التدريس", answer: false, explanation: "التعلم التعاوني يعتبر من استراتيجيات التدريس الحديثة التي تركز على دور المتعلم النشط." },
            { type: "tf", id: "tf_qq_5", text: "من شروط التعلم التعاونى أن تتكون المجموعة من على الأكثر ۰۲ فرد أو ۰۲", answer: false, explanation: "مجموعات التعلم التعاوني الفعالة تتكون عادة من 2 إلى 6 أفراد لضمان المشاركة الفعالة." }, 
            { type: "tf", id: "tf_qq_6", text: "التعلم بالبحث يساعد المتعلمين على السعى نحو المعلومات والحلول تجاه موضوع ما", answer: true },
            { type: "tf", id: "tf_qq_7", text: "استخدام التعلم بالبحث ينمى لدى المتعلم مهارات التعلم الذاتي", answer: true },
            { type: "tf", id: "tf_qq_8", text: "استخدام التعلم بالبحث لا يساعد المتعلم على اكتساب الثقه بالنفس", answer: false, explanation: "بالعكس، التعلم بالبحث والوصول للنتائج يعزز ثقة المتعلم بنفسه وقدراته." },
            { type: "tf", id: "tf_qq_9", text: "إجراء التجارب والتمارين والأنشطة من صور التعلم بالبحث", answer: true },
            { type: "tf", id: "tf_qq_10", text: "مهارات التأكيد على المفاهيم والافكار الرئيسية من مهارات التعلم بالبحث", answer: true },
            { type: "tf", id: "tf_qq_11", text: "التعلم الالكتروني هو منظومة تعليمية لتقديم البرامج التعليمية للمتعلمين فى اى وقت واي مكان", answer: true },
            { type: "tf", id: "tf_qq_12", text: "من أسس التعلم الالكترونى التقييد بالزمان والمكان", answer: false, explanation: "من أهم مميزات التعلم الإلكتروني المرونة وعدم التقييد بالزمان والمكان." },
            { type: "tf", id: "tf_qq_13", text: "بيئات التعلم التقليدى هى كل البيئات التي يوجد فيها كل من المعلم والمتعلم والمحتوى التعليمى في حيز واحد", answer: true },
            { type: "tf", id: "tf_qq_14", text: "بيئة التعلم الالكتروني تسمح للطالب بالتفاعل مع مصادر التعلم البشرية وغير البشرية", answer: true },
            { type: "tf", id: "tf_qq_15", text: "التمركز حول المعلم من خصائص بيئات التعلم التفاعلية الالكترونية", answer: false, explanation: "بيئات التعلم التفاعلية الإلكترونية الحديثة تتمحور حول المتعلم وتفاعله." },
            { type: "tf", id: "tf_qq_16", text: "ارتباط الاستراتيجية بالمحتوى التدريسي من اسس توظيف استراتيجيات التعلم الإلكتروني", answer: false, explanation: "الأساس الأهم هو ارتباط الاستراتيجية بالأهداف التعليمية المراد تحقيقها." }, 
            { type: "tf", id: "tf_qq_17", text: "من اسس توظيف استراتيجيات التعلم الإلكتروني المرونة والقابلية للتطوير", answer: true },
            { type: "tf", id: "tf_qq_18", text: "موقف التعلم ومتطلباته من معايير اختيار استراتيجيات التعلم الالكتروني", answer: true },
            { type: "tf", id: "tf_qq_19", text: "المحاضرة الالكترونية هي طريقه ذات اتجاه واحد من المعلم الى طلابه", answer: true, explanation: "بشكلها التقليدي، نعم، ولكن يمكن دمج عناصر تفاعلية فيها." },
            { type: "tf", id: "tf_qq_20", text: "من مميزات المحاضرة الالكترونية مشاهدة المتعلم المحاضرة في وقت ومكان محدد", answer: false, explanation: "من مميزاتها إمكانية مشاهدتها في أي وقت ومكان يناسب المتعلم." }, 
            { type: "tf", id: "tf_qq_21", text: "تقدم العروض الالكترونية وفق نمطين نمط متزامن ونمط غير متزامن", answer: true },
            { type: "tf", id: "tf_qq_22", text: "تستخدم العروض الالكترونية في تدريس العلاقات المتبادلة والتمكن من المهارات", answer: true },
            { type: "tf", id: "tf_qq_23", text: "أسلوب التدريس هو طريقة من طرق التدريس التي يتبعها المعلم.", answer: true }, // Note: Previous answer in source was X for Q1.
            { type: "tf", id: "tf_qq_24", text: "الأهداف السلوكية هى أهداف تصف ما يقوم به المعلم.", answer: false }, 
            { type: "tf", id: "tf_qq_25", text: "يركز المجال الوجداني للأهداف على القيم والإتجاهات والميول التي يجب أن يكتسبها المتعلمين.", answer: true }, 
            { type: "tf", id: "tf_qq_26", text: "التعلم التعاوني هو طريقة تقليدية في التدريس.", answer: false }, 
            { type: "tf", id: "tf_qq_27", text: "من شروط التعلم التعاونى أن تتكون المجموعة من ۲۰ فرد أو ٢٥ على الأكثر.", answer: false }, 
            { type: "tf", id: "tf_qq_28", text: "التعلم بالبحث يساعد المتعلمين على السعى نحو المعلومات والحلول تجاه موضوع ما.", answer: true }, 
            { type: "tf", id: "tf_qq_29", text: "استخدام التعلم بالبحث ينمى لدى المتعلم مهارات التعلم الذاتي.", answer: true }, 
            { type: "tf", id: "tf_qq_30", text: "استخدام التعلم بالبحث لا يساعد المتعلم على اكتساب الثقه بالنفس.", answer: false }, 
            { type: "tf", id: "tf_qq_31", text: "إجراء التجارب والتمارين والأنشطة من صور التعلم بالبحث.", answer: true }, 
            { type: "tf", id: "tf_qq_32", text: "مهارات التأكيد على المفاهيم والافكار الرئيسية من مهارات التعلم بالبحث.", answer: true }, 
            { type: "tf", id: "tf_qq_33", text: "التعلم هو عملية ذاتية وفردية يقوم بها المتعلم لاكتساب المعرفة والمهارات والخبرات من خلال التفاعل في البيئة المحيطة", answer: true },
            { type: "tf", id: "tf_qq_34", text: "التعلم يعتمد على دافعية المتعلم واستعدادة النفسي", answer: true },
            { type: "tf", id: "tf_qq_35", text: "التعلم هو عملية ذاتية يقوم بها المعلم لاكتساب المعرفة", answer: false },
            { type: "tf", id: "tf_qq_36", text: "التعلم هو عملية يقوم بها المعلم لايصال المعرفة للمتعلمين", answer: false, explanation: "هذا وصف للتعليم، وليس التعلم الذي يقوم به المتعلم." },
            { type: "tf", id: "tf_qq_37", text: "التدريس هو عبارة عن طريقة التدريس التي يستخدمها المعلم", answer: false, explanation: "التدريس عملية أشمل تتضمن التخطيط والتنفيذ والتقويم، وطريقة التدريس جزء منها." },
            { type: "tf", id: "tf_qq_38", text: "التدريس اطار عملي يجمع بين التعليم والتعلم", answer: true },
            { type: "tf", id: "tf_qq_39", text: "التدريس عملية تفاعلية تضمن تخطيطا وتنفيذا وتقويماً من قبل المعلم", answer: true },
            { type: "tf", id: "tf_qq_40", text: "التدريس هو شرح الدروس من قبل المعلم", answer: false, explanation: "شرح الدروس هو جزء صغير من عملية التدريس الشاملة." },
            { type: "tf", id: "tf_qq_41", text: "طريقة التدريس تشمل أسلوب التدريس واستراتيجية التدريس", answer: false, explanation: "الاستراتيجية عادة ما تكون أعم وتشمل الطريقة والأسلوب." },
            { type: "tf", id: "tf_qq_42", text: "أسلوب التدريس اعم واشمل من طريقة التدريس", answer: false, explanation: "طريقة التدريس هي الإجراءات العامة، والأسلوب هو الكيفية الشخصية لتنفيذ الطريقة." },
            { type: "tf", id: "tf_qq_43", text: "استراتيجية التدريس تشمل أسلوب وطريقة التدريس", answer: true },
            { type: "tf", id: "tf_qq_44", text: "تتكون منظومة التدريس من الكتاب المدرسي والمتعلم", answer: false, explanation: "منظومة التدريس تشمل عناصر متعددة كالمعلم، المتعلم، المحتوى، البيئة، أساليب التقويم وغيرها." },
            { type: "tf", id: "tf_qq_45", text: "عملية التدريس تتكون من مرحلتين تخطيط وتنفيذ", answer: false, explanation: "عملية التدريس تتكون من ثلاث مراحل رئيسية: التخطيط، التنفيذ، والتقويم." }, 
            { type: "tf", id: "tf_qq_46", text: "الأهداف التربوية هي اهداف المناهج الدراسية", answer: false, explanation: "أهداف المناهج الدراسية هي جزء من الأهداف التربوية العامة والأوسع نطاقًا." },
            { type: "tf", id: "tf_qq_47", text: "تنقسم مستويات الأهداف التربوية الى اهداف عامة و اهداف خاصة و اهداف سلوكية", answer: true },
            { type: "tf", id: "tf_qq_48", text: "الأهداف التربوية تساعد المعلم في اختيار استراتيجيات التدريس المناسبة للاهداف ومستوى المتعلمين", answer: true },
            { type: "tf", id: "tf_qq_49", text: "يركز المجال المهاري على تنمية المهارات والقيم والاتجاهات", answer: false, explanation: "المجال المهاري (النفسحركي) يركز على تنمية المهارات الحركية والأدائية." }, 
            { type: "tf", id: "tf_qq_50", text: "الهدف السلوكي الجيد يصف سلوك المتعلم", answer: true },
            { type: "tf", id: "tf_qq_51", text: "الهدف السلوكي الجيد يجب ان يكون هدف مركبا", answer: false, explanation: "الهدف السلوكي الجيد يجب أن يكون بسيطا، محددا، قابلا للملاحظة والقياس، وليس مركبا." }, 
            { type: "tf", id: "tf_qq_52", text: "طريقة التدريس هي وسيلة المعلم من أجل إيصال أهداف الدرس لطلابه", answer: true },
            { type: "tf", id: "tf_qq_53", text: "استراتيجية التدريس هي خطة المعلم الشاملة لتحقيق الأهداف بعيدة المدى", answer: true },
            { type: "tf", id: "tf_qq_54", text: "استراتيجية التدريس هي خطة شاملة يضعها المعلم لتحقيق الأهداف قريبة المدى", answer: false, explanation: "الاستراتيجية ترتبط بتحقيق الأهداف العامة وبعيدة المدى، بينما التكتيكات والأساليب قد ترتبط بالأهداف قصيرة المدى." },
            { type: "tf", id: "tf_qq_55", text: "توجد في طرق التدريس بعض الطرق المثالية تماما التي ينبغي استخدامها", answer: false, explanation: "لا توجد طريقة تدريس مثالية لجميع المواقف والمتعلمين، بل يتم اختيار الأنسب حسب عدة عوامل." },
            { type: "tf", id: "tf_qq_56", text: "طريقة التعلم التعاوني من طرق التدريس التقليدي", answer: false },
            { type: "tf", id: "tf_qq_57", text: "طرائق التدريس الحديثة يكون المتعلم محوراً للعملية التعليمية", answer: true },
            { type: "tf", id: "tf_qq_58", text: "طرق التدريس التقليدية تكون المتعلم محورا للعملية التعليمية", answer: false, explanation: "في الطرق التقليدية، غالبًا ما يكون المعلم هو محور العملية التعليمية." },
            { type: "tf", id: "tf_qq_59", text: "من القواعد العامة التي تبنى عليها طرق التدريس التدرج من الصعب الى السهل", answer: false, explanation: "القاعدة العامة هي التدرج من السهل إلى الصعب." }, 
            { type: "tf", id: "tf_qq_60", text: "من القواعد العامة التي تبنى عليها طرق التدريس التدرج من المحسوس الى المعقول", answer: true },
            { type: "tf", id: "tf_qq_61", text: "طريقة المحاضرة تعتبر من الطرق الحديثة في التدريس", answer: false, explanation: "طريقة المحاضرة تعتبر من الطرق التقليدية." },
            { type: "tf", id: "tf_qq_62", text: "طريقة المحاضرة لا تسمح بعرض المعلومات بطريقة منظمة", answer: false, explanation: "من مميزات طريقة المحاضرة أنها تسمح بعرض المعلومات بطريقة منظمة ومتسلسلة." },
            { type: "tf", id: "tf_qq_63", text: "تعد طريقة المناقشة من طرائق التدريس التقليدية", answer: true, explanation: "يمكن اعتبارها تقليدية في جذورها، ولكنها أكثر تفاعلية من المحاضرة البحتة ويمكن تطويرها لتكون حديثة." }, 
            { type: "tf", id: "tf_qq_64", text: "من شروط المشكلة المختارة للدراسة ان تكون ذات صلة بالدرس", answer: true },
            { type: "tf", id: "tf_qq_65", text: "أسلوب التدريس هو طريقة من طرق التدريس الذي يتبعها المعلم في التدريس", answer: true },
            { type: "tf", id: "tf_qq_66", text: "الأهداف السلوية هي اهداف تصف ما يقوم به المعلم", answer: false }, 
            { type: "tf", id: "tf_qq_67", text: "يركز المجال الوجداني للأهداف على القيم والاتجاهات والميول التي يجب أن يكتسبها المتعلمون", answer: true }, 

            // --- Multiple Choice Questions ---
            { type: "mcq", id: "mcq_qq_1", text: "ما يلي من مميزات طريقة المحاضرة عدا:", options: ["طريقة تدريس اقتصادية", "تسهم في تذكر الطلاب للمعلومات", "تغطي حجم كبير من محتوى المقرر", "لا تحتاج لاماكنيات كبير"], correctAnswerText: "تسهم في تذكر الطلاب للمعلومات", explanation: "المحاضرة قد لا تكون الأفضل لتذكر المعلومات على المدى الطويل مقارنة بالطرق التفاعلية التي تشرك الطالب بشكل أكبر." },
            { type: "mcq", id: "mcq_qq_2", text: "مراحل عملية التدريس هي:", options: ["مرحلة التخطيط", "مرحلة التقويم", "مرحلة التنفيذ", "جميع ما سبق"], correctAnswerText: "جميع ما سبق", explanation: "عملية التدريس تشمل التخطيط المسبق، ثم تنفيذ الخطة، وأخيراً تقويم نتائج عملية التعلم والتعليم." },
            { type: "mcq", id: "mcq_qq_3", text: "من النتقادات الموجهة لطريقة المحاضرة:", options: ["تثير دافعية الطلبة للتعليم", "يمكن من خلالها إعطاء كم من المعلومات", "لا تأخذ في الاعتبار الفروق الفردية بين الطلبة", "تأخذ في الاعتبار الفروق الفردية"], correctAnswerText: "لا تأخذ في الاعتبار الفروق الفردية بين الطلبة", explanation: "طريقة المحاضرة غالبًا ما تقدم المحتوى بنفس الطريقة لجميع الطلاب، مما قد لا يناسب جميع أنماط التعلم أو مستويات الفهم." },
            { type: "mcq", id: "mcq_qq_4", text: "لطريقة المناقشة عدة عيوب منها:", options: ["اشتراك عدد كبير من المتعلمين في المناقشة", "استماع المتعلمين لما يطرحة زملاؤهم", "سيطرة عدد محدود من المتعلمين على المناقشة", "تمكن المعلم من السيطرة على المناقشة"], correctAnswerText: "سيطرة عدد محدود من المتعلمين على المناقشة" },
            { type: "mcq", id: "mcq_qq_5", text: "من المبادئ التي يجب ان يراعيها المعلم لتحسين طريقة التدريس:", options: ["مراعاة الفروق الفردية بين المتعلمين", "توفر مبادئ التعلم والتعليم في الطريقة", "تنظيم المحتوى بطريقة تباعد على التعلم الذاتي", "جميع ما سبق ذكرة"], correctAnswerText: "جميع ما سبق ذكرة" },
            { type: "mcq", id: "mcq_qq_6", text: "ما يلي من معايير اختيار طريقة التدريس عدا:", options: ["التدرج من الصعب الى السهل", "التدرج من البسيط الى المركب", "الانتقال من العملي الى النظري", "الانتقال من المحسوس الى المعقول"], correctAnswerText: "التدرج من الصعب الى السهل", explanation: "المعيار الصحيح هو التدرج من السهل إلى الصعب لبناء الفهم تدريجيًا." },
            { type: "mcq", id: "mcq_qq_7", text: "ما يلي من استخدامات المحاضرة في مجالات عديدة ماعدا:", options: ["مناقشة الطلاب فيما يفعلونة", "تقديد موضوع جديد", "تلخيص ما سبق للطلة دراستة", "توجية وارشاد الطلبة الى مصادر معروفة"], correctAnswerText: "مناقشة الطلاب فيما يفعلونة", explanation: "مناقشة الطلاب هي سمة أساسية لطريقة المناقشة، وليست من استخدامات المحاضرة التقليدية التي تكون عادة أحادية الاتجاه." },
            { type: "mcq", id: "mcq_qq_8", text: "من مزايا طريقة المناقشة:", options: ["تدفع المتعلمين الى المشاركة بالدرس", "تنمي القدرات الفكرية والمعرفية للمتعلين", "تنمي لدى المتعلمين حب التعاون والعمل الجماعي", "جميع ما سبق ذكرة"], correctAnswerText: "جميع ما سبق ذكرة" },
            { type: "mcq", id: "mcq_qq_9", text: "ما يلي من إجراءات طريقة حل المشكلات ماعدا:", options: ["الوصول الى احكام عامة حول المشكلة", "مناقشة الموضوعات القريبة للمشكلة", "الإحساس بالمشكلة", "تحديد المشكلة"], correctAnswerText: "مناقشة الموضوعات القريبة للمشكلة" },
            { type: "mcq", id: "mcq_qq_10", text: "من شروط المشكلة المختارة للدراسة:", options: ["تكويت مناسبة للدراسة وذات صلة قوية بالدرس", "تكون من المشكلات التي يعاني منها المجتمع", "تكون ذات صلة بمشكلات البيئة", "جميع ما سبق"], correctAnswerText: "جميع ما سبق" },
            { type: "mcq", id: "mcq_qq_21", text: "من إجراءات طريقة حل المشكلة:", options: ["يساعد المعلم طلابه على اختيار المشكلة المناسبة", "التقويم المستمر المصاحب لطريقة حل المشكلات", "يحث المعلم طلابه على القراءة والاطلاع على مصادر المعرفة", "جميع ما سبق"], correctAnswerText: "جميع ما سبق" },
            { type: "mcq", id: "mcq_qq_22", text: "ما يلي من مزايا طريقة حل المشكلات ماعدا:", options: ["تنمية التفكير العلمي عند الطلاب", "تنمية المهارات العملية والتطبيقية للطلاب", "تنمية روح العمل الجماعي بين الطلاب", "تدريب المتعلمين على مواجهة المشكلات في الحياة الواقعية"], correctAnswerText: "تنمية المهارات العملية والتطبيقية للطلاب", explanation: "جميع الخيارات هي من مزايا طريقة حل المشكلات. قد يكون السؤال يبحث عن الميزة الأقل مباشرة أو الأقل أهمية نسبياً، ولكنها جميعها صحيحة." }, 
            { type: "mcq", id: "mcq_qq_23", text: "من عيوب طريقة حل المشكلات:", options: ["الاعتماد على المعلم وحده في اختيار المشكلة", "عدم تعويد الطلاب على مهارات المناقشة", "قلة المعلومات او المادة العلمية", "جميع ما سبق"], correctAnswerText: "جميع ما سبق" },
            { type: "mcq", id: "mcq_qq_24", text: "للاهداف التربوية أهمية منها:", options: ["تسهم في تصميم المناهج الدراسية", "المساعدة في اختيار استراتيجيات التدريس", "أداة لتقويم اداء الطلاب وتحديد مدى تقدمهم", "جميع ما سبق"], correctAnswerText: "جميع ما سبق" },
            { type: "mcq", id: "mcq_qq_25", text: "تصنف الأهداف التعليمية الى:", options: ["أهداف تربوية وأهداف تعليمية", "أهداف عامه وأهداف خاصة وأهداف سلوكية", "أهداف اجرائية وأهداف نفسية وأهداف اجتماعية", "أهداف وجدانية وأهداف تربوية وأهداف سلوكية"], correctAnswerText: "أهداف عامه وأهداف خاصة وأهداف سلوكية" },
            { type: "mcq", id: "mcq_qq_26", text: "تصنف الاهداف بناء على المجالات التعليمية الى:", options: ["أهداف المناهج الدراسية وأهداف الصفوف الدراسية", "اهداف المجال المعرفى وأهداف المجال الوجداني واهداف المجال المهاري", "الاهداف السيكولوجية والاهداف الانفعالية والاهداف التعليمية", "الاهداف التعليمية والنفسية والتربوية"], correctAnswerText: "اهداف المجال المعرفى وأهداف المجال الوجداني واهداف المجال المهاري" },
            { type: "mcq", id: "mcq_qq_27", text: "تصنيف الاهداف التعليمية له اهمية منها:", options: ["توضيح الرؤية", "التخطيط الفعال", "التقويم المنهجي", "جميع ماسبق"], correctAnswerText: "جميع ماسبق" },
            { type: "mcq", id: "mcq_qq_28", text: "ما يلي من مواصفات الهدف السلوكي ماعدا:", options: ["يصف سلوك المتعلم", "واضح المعنى وقابل للفهم", "يصف سلوك المعلم", "قابل للملاحظة والقياس"], correctAnswerText: "يصف سلوك المعلم" },
            { type: "mcq", id: "mcq_qq_29", text: "فيما يلى مجموعة من الاهداف السلوكية الصحيحة ماعدا:", options: ["أن يشرح المعلم مكونات الحاسب الألى", "أن يذكر التلميذ وظائف الحاسب الألى", "أن يرسم المتعلم مكونات الحاسب الألى", "أن يقدر المتعلم قيمة الحاسب الألى في الحياة العملية"], correctAnswerText: "أن يشرح المعلم مكونات الحاسب الألى" },
            { type: "mcq", id: "mcq_qq_30", text: "يرتكز التعلم الالكترونى وفق منظوره الحديث على عدة أسس منها:", options: ["المتعلم إيجابي ونشط", "الاعتماد على توليد المعارف وليس استقبالها", "المعلم موجه ومرشد ومصمم لبيئة التعلم", "جميع ما سبق"], correctAnswerText: "جميع ما سبق" },
            { type: "mcq", id: "mcq_qq_31", text: "ما يلى من خصائص بيئات التعلم التفاعلية الالكترونية ماعدا:", options: ["التمركز حول المعلم", "تعاونية والمشاركة", "اللاتزامنية في الزمان والمكان", "الموضوعية وعدم التحيز"], correctAnswerText: "التمركز حول المعلم" },
            { type: "mcq", id: "mcq_qq_32", text: "توجد مجموعة من الاسس لتوظيف استراتيجيات التعلم الإلكتروني منها:", options: ["ارتباط الاستراتيجية بأساليب التقويم", "ارتباط الاستراتيجية بالأهداف.", "مراعاة ظروف المعلمين في بيئة التعلم", "جميع ما سبق."], correctAnswerText: "ارتباط الاستراتيجية بالأهداف." }, 
            { type: "mcq", id: "mcq_qq_33", text: "اختيار استراتيجيات التعلم الإلكتروني له عدة معايير منها:", options: ["المعلمين القائمين بالتدريس", "تعدد البيئات التعليمية الالكترونية.", "المتعلمين وخصائصهم", "جميع ما سبق."], correctAnswerText: "جميع ما سبق." },
            { type: "mcq", id: "mcq_qq_34", text: "المحاضرة الالكترونية لها عدة مميزات منها:", options: ["يشاهد المتعلم المحاضرة فى المكان والوقت المناسب له", "استعراض مجموعة كبيرة من الخصائص والمفاهيم فى فترة زمنية قصيره", "إمكانية إعادة تشغيلها أو أجزاء منها لمرات متعددة", "جميع ما سبق"], correctAnswerText: "جميع ما سبق" },
            { type: "mcq", id: "mcq_qq_35", text: "للتعلما لتعاوني فوائد عديدة منها:", options: ["تبادل الافكار بين الطلاب .", "مساعدة المعلمين في تنفيذ خططهم التدريسية.", "زيادة الدافعية للتعلم الذاتي", "جميع ما سبق."], correctAnswerText: "جميع ما سبق." }, 
            { type: "mcq", id: "mcq_qq_36", text: "ما يلى من شروط التعلم التعاوني ماعدا:", options: ["الانضباط وعدم استغلال الوقت في اللهو", "المجموعة تتكون من ٤ افراد او ٦ على الأكثر", "المعلم مرجعا للطلاب في كل وقت", "اعتماد كل من الطلبة على الأخر"], correctAnswerText: "اعتماد كل من الطلبة على الأخر" },
            { type: "mcq", id: "mcq_qq_37", text: "التعلم بالبحث له اهمية منها:", options: ["جعل التعلم أسرع .", "جعل التعلم أمتع وأعمق.", "تنمية مهارات التعلم الذاتي لدى المتعلم .", "جميع ما سبق."], correctAnswerText: "جميع ما سبق." } 
        ];
        // --- Questions End ---

        let sessionQuestions = []; // Holds the questions for the current exam session (possibly shuffled)
        let currentQuestionIndex = 0;
        let userAnswers = []; // Stores { questionId: string, userAnswerValue: string, isCorrect: boolean, correctAnswer: string, questionIndexInSession: number }
        let flaggedQuestions = []; // Stores question IDs that are flagged
        let timerInterval;
        let timeLeftInSeconds = 45 * 60; // 45 minutes
        const EXAM_DURATION_SECONDS = 45 * 60;


        const landingPage = document.getElementById('landingPage');
        const examPage = document.getElementById('examPage');
        const questionDisplayArea = document.getElementById('questionDisplayArea');
        const progressInfoText = document.getElementById('progressInfoText');
        const progressBarFill = document.getElementById('progressBarFill');
        const nextBtn = document.getElementById('nextBtn');
        const prevBtn = document.getElementById('prevBtn'); 
        const resultsArea = document.getElementById('resultsArea');
        const navigationControls = document.getElementById('navigationControls');
        const scoreContainer = document.getElementById('scoreContainer');
        const detailedFeedbackContainer = document.getElementById('detailedFeedbackContainer');
        const timerDisplay = document.getElementById('timerDisplay');
        const totalQuestionsLandingSpan = document.getElementById('totalQuestionsLanding');
        const examDurationLandingSpan = document.getElementById('examDurationLanding');


        const viewLastResultsBtn = document.getElementById('viewLastResultsBtn');
        const oldResultsPage = document.getElementById('oldResultsPage');
        const oldScoreContainer = document.getElementById('oldScoreContainer');
        const oldDetailedFeedbackContainer = document.getElementById('oldDetailedFeedbackContainer');
        
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const themeToggleBtnOldResults = document.getElementById('themeToggleBtnOldResults');
        const questionNavModal = document.getElementById('questionNavModal');
        const qNavGridContainer = document.getElementById('qNavGridContainer');


        const LAST_RESULTS_KEY = 'loftExamLastResults_v2'; // Added v2 for new structure
        const CURRENT_EXAM_STATE_KEY = 'loftCurrentExamState_v2';
        const THEME_KEY = 'loftExamTheme';

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function applyTheme(theme) {
            document.body.className = theme; // Removes other classes, sets only theme
            const iconClass = theme === 'dark-theme' ? 'fa-sun' : 'fa-moon';
            if (themeToggleBtn) themeToggleBtn.innerHTML = `<i class="fas ${iconClass}"></i>`;
            if (themeToggleBtnOldResults) themeToggleBtnOldResults.innerHTML = `<i class="fas ${iconClass}"></i>`;
            localStorage.setItem(THEME_KEY, theme);
             // Update RGB color variables based on theme for dynamic alpha in box-shadows
            if (theme === 'dark-theme') {
                document.documentElement.style.setProperty('--primary-color-rgb', '0,170,255');
                document.documentElement.style.setProperty('--secondary-color-rgb', '142,142,147');
                document.documentElement.style.setProperty('--success-color-rgb', '48,209,88');
                document.documentElement.style.setProperty('--danger-color-rgb', '255,69,58');
                document.documentElement.style.setProperty('--warning-color-rgb', '255,159,10');
            } else { // light-theme
                document.documentElement.style.setProperty('--primary-color-rgb', '0,122,255');
                document.documentElement.style.setProperty('--secondary-color-rgb', '160,160,176');
                document.documentElement.style.setProperty('--success-color-rgb', '40,167,69');
                document.documentElement.style.setProperty('--danger-color-rgb', '220,53,69');
                document.documentElement.style.setProperty('--warning-color-rgb', '255,193,7');
            }
        }

        function toggleTheme() {
            const currentTheme = document.body.classList.contains('dark-theme') ? 'dark-theme' : 'light-theme';
            const newTheme = currentTheme === 'dark-theme' ? 'light-theme' : 'dark-theme';
            applyTheme(newTheme);
        }


        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            if (!timerDisplay) return;
            timerDisplay.textContent = formatTime(timeLeftInSeconds);
            const warningColorRGB = document.body.classList.contains('dark-theme') ? '255,159,10' : '255,193,7';
            const dangerColorRGB = document.body.classList.contains('dark-theme') ? '255,69,58' : '220,53,69';

            if (timeLeftInSeconds <= 0) { 
                timerDisplay.textContent = '00:00';
                timerDisplay.style.color = 'var(--danger-color)';
                timerDisplay.style.backgroundColor = `rgba(${dangerColorRGB}, 0.15)`;
            } else if (timeLeftInSeconds <= 60) {
                timerDisplay.style.color = 'var(--danger-color)';
                timerDisplay.style.backgroundColor = `rgba(${dangerColorRGB}, 0.15)`;
            } else { 
                timerDisplay.style.color = 'var(--warning-color)';
                timerDisplay.style.backgroundColor = `rgba(${warningColorRGB}, 0.1)`;
            }
        }


        function startTimer() {
            updateTimerDisplay(); 
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeftInSeconds--;
                updateTimerDisplay();
                if (timeLeftInSeconds <= 0) {
                    clearInterval(timerInterval);
                    timeLeftInSeconds = 0; 
                    updateTimerDisplay(); 
                    if (!(resultsArea.style.display === 'block' && resultsArea.classList.contains('visible'))) {
                        alert("انتهى الوقت! سيتم تصحيح إجاباتك الآن.");
                        autoSubmitExam();
                    }
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function saveCurrentExamState() {
            if (examPage.style.display !== 'block' || (resultsArea.style.display === 'block' && resultsArea.classList.contains('visible'))) {
                return;
            }
            const sessionQuestionIdsInOrder = sessionQuestions.map(q => q.id);
            const stateToSave = {
                sessionQuestionIdsInOrder: sessionQuestionIdsInOrder,
                currentQuestionIndex: currentQuestionIndex,
                userAnswers: userAnswers,
                flaggedQuestions: flaggedQuestions,
                timeLeftInSeconds: timeLeftInSeconds,
                timestamp: Date.now()
            };
            try {
                localStorage.setItem(CURRENT_EXAM_STATE_KEY, JSON.stringify(stateToSave));
            } catch (e) { console.error("Error saving current exam state:", e); }
        }

        function clearCurrentExamState() {
            try {
                localStorage.removeItem(CURRENT_EXAM_STATE_KEY);
            } catch (e) { console.error("Error clearing current exam state:", e); }
        }

        function loadAndRestoreExamState() {
            try {
                const savedStateJSON = localStorage.getItem(CURRENT_EXAM_STATE_KEY);
                if (!savedStateJSON) return false;

                const savedState = JSON.parse(savedStateJSON);
                
                // Reconstruct sessionQuestions based on saved order
                if (!savedState.sessionQuestionIdsInOrder || savedState.sessionQuestionIdsInOrder.length === 0) {
                    clearCurrentExamState(); return false; // Invalid state
                }
                sessionQuestions = savedState.sessionQuestionIdsInOrder.map(id => allQuestions.find(q => q.id === id)).filter(q => q); // Filter out undefined if any mismatch
                
                if(sessionQuestions.length !== savedState.sessionQuestionIdsInOrder.length || sessionQuestions.length === 0){
                     clearCurrentExamState(); return false; // Mismatch or empty
                }

                currentQuestionIndex = savedState.currentQuestionIndex;
                userAnswers = savedState.userAnswers || [];
                flaggedQuestions = savedState.flaggedQuestions || [];
                timeLeftInSeconds = savedState.timeLeftInSeconds;


                if (timeLeftInSeconds <= 0 || currentQuestionIndex >= sessionQuestions.length) {
                    clearCurrentExamState(); 
                    return false; 
                }

                landingPage.style.display = 'none';
                if(oldResultsPage) oldResultsPage.style.display = 'none';
                
                examPage.style.display = 'block';
                examPage.style.opacity = '1';
                examPage.style.transform = 'none';
                examPage.style.animation = '';

                resultsArea.style.display = 'none';
                resultsArea.classList.remove('visible');
                navigationControls.style.display = 'flex'; 
                questionDisplayArea.style.display = 'block';

                startTimer(); 
                displayCurrentQuestion();
                renderQuestionNavPanel();
                
                return true;
            } catch (e) {
                console.error("Error loading/restoring exam state:", e);
                clearCurrentExamState();
                return false;
            }
        }

        function startExam(randomize = false) {
            clearCurrentExamState(); 
            stopTimer(); 

            if (randomize) {
                sessionQuestions = shuffleArray(allQuestions);
            } else {
                sessionQuestions = [...allQuestions];
            }

            landingPage.style.animation = 'fadeOutSlideUp 0.4s ease-in forwards';
            if(oldResultsPage) oldResultsPage.style.display = 'none';

            setTimeout(() => {
                landingPage.style.display = 'none';
                landingPage.style.animation = '';

                examPage.style.display = 'block';
                examPage.style.opacity = '0';
                examPage.style.transform = 'scale(0.95)';
                examPage.style.animation = 'fadeInScaleUp 0.5s ease-out forwards';

                currentQuestionIndex = 0;
                userAnswers = [];
                flaggedQuestions = [];
                timeLeftInSeconds = EXAM_DURATION_SECONDS; 

                resultsArea.style.display = 'none';
                resultsArea.classList.remove('visible');
                navigationControls.style.display = 'flex'; 
                questionDisplayArea.style.display = 'block';
                
                if(prevBtn) prevBtn.disabled = true; 
                if(nextBtn) {
                    nextBtn.disabled = true;
                    nextBtn.innerHTML = `السؤال التالي <i class="fas fa-chevron-left icon-after-text"></i>`;
                }
                
                startTimer();
                displayCurrentQuestion();
                renderQuestionNavPanel();
            }, 400);
        }
        
        function handleAnswerSelection() {
            // This function is called when an option is selected.
            // It saves the current answer temporarily before the user clicks "Next".
            // This is useful if the user navigates away using the nav panel.
            const selectedOption = document.querySelector('input[name="q_option"]:checked');
            if (!selectedOption || currentQuestionIndex >= sessionQuestions.length) {
                if(nextBtn) nextBtn.disabled = true;
                return;
            }
            if(nextBtn) nextBtn.disabled = false;


            const currentQ = sessionQuestions[currentQuestionIndex];
            const existingAnswerIndex = userAnswers.findIndex(ans => ans.questionId === currentQ.id);
            
            let userAnswerValue = selectedOption.value;
            let isCorrect = false;
            let correctAnswerText;

            if (currentQ.type === "tf") {
                const userAnswerBoolean = (userAnswerValue === 'true');
                isCorrect = (userAnswerBoolean === currentQ.answer);
                correctAnswerText = currentQ.answer ? 'صحيح' : 'خطأ';
            } else if (currentQ.type === "mcq") {
                isCorrect = (userAnswerValue === currentQ.correctAnswerText);
                correctAnswerText = currentQ.correctAnswerText;
            }
            
            const answerData = {
                questionId: currentQ.id,
                userAnswerValue: userAnswerValue,
                isCorrect: isCorrect,
                correctAnswer: correctAnswerText,
                questionIndexInSession: currentQuestionIndex // Store index in the current session's question order
            };

            if (existingAnswerIndex !== -1) {
                userAnswers[existingAnswerIndex] = answerData;
            } else {
                userAnswers.push(answerData);
            }
            renderQuestionNavPanel(); // Update nav panel to show as answered
            saveCurrentExamState(); // Save state immediately on answer selection
        }


        function handleNextQuestion() {
            if (timeLeftInSeconds <= 0 && timerInterval) return;

            const selectedOption = document.querySelector('input[name="q_option"]:checked');
            if (!selectedOption) {
                alert("الرجاء اختيار إجابة للمتابعة.");
                return;
            }
            
            handleAnswerSelection(); // Ensure answer is processed/saved

            currentQuestionIndex++;
            // saveCurrentExamState(); // Already saved in handleAnswerSelection or if not, save here too

            if (currentQuestionIndex >= sessionQuestions.length) {
                stopTimer();
                showResults();
            } else {
                displayCurrentQuestion();
                renderQuestionNavPanel(); // Update for current question highlight
            }
        }

        function handlePreviousQuestion() {
            if (currentQuestionIndex > 0) {
                // Answer for current question should have been saved by onchange via handleAnswerSelection
                currentQuestionIndex--;
                saveCurrentExamState(); 
                displayCurrentQuestion();
                renderQuestionNavPanel();
            }
        }
        
        function autoSubmitExam() {
            if ((resultsArea.style.display === 'block' && resultsArea.classList.contains('visible')) || examPage.style.display !== 'block') {
                return;
            }
            stopTimer(); 
            handleAnswerSelection(); // Process any selected answer for the current question
            showResults(); 
            if(nextBtn) nextBtn.disabled = true;
            if(prevBtn) prevBtn.disabled = true;
            const radioInputs = questionDisplayArea.querySelectorAll('input[type="radio"]');
            if(radioInputs) radioInputs.forEach(input => input.disabled = true);
        }

        function showResults() {
            if (resultsArea.classList.contains('visible')) return;

            stopTimer(); 
            clearCurrentExamState(); 

            questionDisplayArea.style.display = 'none';
            navigationControls.style.display = 'none'; 
            if(progressInfoText) progressInfoText.textContent = 'اكتمل الاختبار!';
            if(progressBarFill) progressBarFill.style.width = '100%';
            if(progressBarFill.parentElement) progressBarFill.parentElement.setAttribute('aria-valuenow', '100');
            
            resultsArea.style.display = 'block';
            resultsArea.classList.add('visible');
            resultsArea.style.opacity = '0'; 
            resultsArea.style.transform = 'translateY(20px)';
            resultsArea.style.animation = 'fadeInSlideUp 0.5s ease-out forwards';

            let score = 0;
            detailedFeedbackContainer.innerHTML = '';

            // Iterate through sessionQuestions to ensure all questions are accounted for, even if not answered
            sessionQuestions.forEach((q_session, index) => {
                const userAnswerData = userAnswers.find(ans => ans.questionId === q_session.id);
                const originalQuestionData = allQuestions.find(oq => oq.id === q_session.id); // For explanation

                let isCorrect = false;
                let userAnswerDisplay = "لم تتم الإجابة";
                let correctAnswerForDisplay = q_session.type === "tf" ? (q_session.answer ? 'صحيح' : 'خطأ') : q_session.correctAnswerText;


                if (userAnswerData) {
                    isCorrect = userAnswerData.isCorrect;
                    userAnswerDisplay = userAnswerData.userAnswerValue;
                    if (q_session.type === 'tf') {
                        userAnswerDisplay = (userAnswerData.userAnswerValue === 'true') ? 'صحيح' : 'خطأ';
                    }
                }
                if (isCorrect) score++;


                const feedbackItem = document.createElement('div');
                feedbackItem.classList.add('feedback-item', isCorrect ? 'correct' : 'incorrect');
                
                let explanationHTML = '';
                if (originalQuestionData && originalQuestionData.explanation) {
                    explanationHTML = `<div class="explanation"><strong>توضيح:</strong> ${originalQuestionData.explanation}</div>`;
                }

                feedbackItem.innerHTML = `
                    <p><strong>السؤال ${index + 1}:</strong> ${q_session.text}</p>
                    <p class="user-answer">إجابتك: ${userAnswerDisplay}</p>
                    ${!isCorrect ? `<p>الإجابة الصحيحة: <span class="correct-answer-text">${correctAnswerForDisplay}</span></p>` : ''}
                    ${explanationHTML}
                `;
                detailedFeedbackContainer.appendChild(feedbackItem);
            });


            let scoreIcon = '';
            if (score === sessionQuestions.length) {
                scoreContainer.style.backgroundColor = 'var(--success-color)';
                scoreContainer.style.color = 'var(--text-on-primary-button)';
                scoreIcon = '<i class="fas fa-trophy"></i>';
            } else if (score >= sessionQuestions.length * 0.7) {
                scoreContainer.style.backgroundColor = 'var(--success-color)'; 
                scoreContainer.style.color = 'var(--text-on-primary-button)';
                scoreIcon = '<i class="fas fa-check-circle"></i>';
            } else if (score >= sessionQuestions.length * 0.4) {
                scoreContainer.style.backgroundColor = 'var(--warning-color)';
                scoreContainer.style.color = document.body.classList.contains('dark-theme') ? 'var(--app-bg-dark)' : 'var(--text-primary-light)';
                scoreIcon = '<i class="fas fa-exclamation-circle"></i>';
            } else {
                scoreContainer.style.backgroundColor = 'var(--danger-color)';
                scoreContainer.style.color = 'var(--text-on-primary-button)';
                scoreIcon = '<i class="fas fa-times-circle"></i>';
            }
            scoreContainer.innerHTML = `نتيجتك: ${score} من ${sessionQuestions.length} ${scoreIcon}`;


            const resultsToSave = {
                score: score, totalQuestions: sessionQuestions.length, 
                answers: userAnswers, // Save user answers as is
                sessionQuestionIdsInOrder: sessionQuestions.map(q => q.id), // Save the order of questions for this result
                timestamp: new Date().toLocaleString('ar-EG')
            };
            try {
                localStorage.setItem(LAST_RESULTS_KEY, JSON.stringify(resultsToSave));
                if(viewLastResultsBtn) viewLastResultsBtn.disabled = false;
            } catch (e) { console.error("Error saving results to localStorage:", e); }
        }
        
        function restartExam() {
            stopTimer();
            clearCurrentExamState();
            
            resultsArea.style.animation = 'fadeOutSlideUp 0.4s ease-in forwards';
            examPage.style.animation = 'fadeOutSlideUp 0.4s ease-in forwards';

            setTimeout(() => {
                resultsArea.style.display = 'none';
                resultsArea.classList.remove('visible');
                resultsArea.style.animation = '';

                examPage.style.display = 'none';
                examPage.style.animation = '';
                navigationControls.style.display = 'flex'; 

                landingPage.style.display = 'block';
                landingPage.style.opacity = '0';
                landingPage.style.transform = 'translateY(20px)';
                landingPage.style.animation = 'fadeInSlideUp 0.6s ease-out forwards';
                checkForOldResults();
            }, 400);
        }

        function displayCurrentQuestion() {
            if (timeLeftInSeconds <= 0 && timerInterval) {
                if (!(resultsArea.style.display === 'block' && resultsArea.classList.contains('visible'))) {
                    autoSubmitExam();
                }
                return;
            }

            if (currentQuestionIndex >= sessionQuestions.length) {
                if (!(resultsArea.style.display === 'block' && resultsArea.classList.contains('visible'))) {
                     showResults();
                }
                return;
            }

            const q = sessionQuestions[currentQuestionIndex];
            let optionsHTML = '';

            const flagBtn = `
                <button class="flag-question-btn ${flaggedQuestions.includes(q.id) ? 'flagged' : ''}" onclick="toggleFlagQuestion('${q.id}')" aria-pressed="${flaggedQuestions.includes(q.id)}">
                    <i class="fas fa-flag"></i> ${flaggedQuestions.includes(q.id) ? 'إلغاء التعليم' : 'تعليم للمراجعة'}
                </button>`;

            if (q.type === "tf") {
                optionsHTML = `
                    <div class="option-item">
                        <label>
                            <input type="radio" name="q_option" value="true" onchange="handleAnswerSelection()">
                            <span><i class="fas fa-check icon-before-text" style="color: var(--success-color);"></i> صحيح</span>
                        </label>
                    </div>
                    <div class="option-item">
                        <label>
                            <input type="radio" name="q_option" value="false" onchange="handleAnswerSelection()">
                            <span><i class="fas fa-times icon-before-text" style="color: var(--danger-color);"></i> خطأ</span>
                        </label>
                    </div>
                `;
            } else if (q.type === "mcq") {
                optionsHTML = q.options.map(opt => `
                    <div class="option-item">
                        <label>
                            <input type="radio" name="q_option" value="${opt.replace(/"/g, '"')}" onchange="handleAnswerSelection()">
                            <span>${opt}</span>
                        </label>
                    </div>
                `).join('');
            }

            const questionCardHTML = `
                <div class="question-card-loft">
                    <div class="question-actions">
                        <span class="progress-text">السؤال ${currentQuestionIndex + 1} من ${sessionQuestions.length}</span>
                        ${flagBtn}
                    </div>
                    <p class="question-statement">${q.text}</p>
                    <div class="options-list" role="radiogroup" aria-labelledby="questionStatement${q.id}">
                        ${optionsHTML}
                    </div>
                </div>
            `;
             // Add id to question statement for ARIA
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = questionCardHTML;
            tempDiv.querySelector('.question-statement').id = `questionStatement${q.id}`;


            const oldCard = questionDisplayArea.querySelector('.question-card-loft');
            if (oldCard) {
                oldCard.classList.remove('entering');
                oldCard.classList.add('exiting');
                oldCard.addEventListener('animationend', () => {
                    if (oldCard.classList.contains('exiting')) { 
                        questionDisplayArea.innerHTML = tempDiv.innerHTML; // Use modified HTML
                        const newCard = questionDisplayArea.querySelector('.question-card-loft');
                        if (newCard) newCard.classList.add('entering');
                        postRenderQuestionSetup();
                    }
                }, { once: true });
            } else {
                questionDisplayArea.innerHTML = tempDiv.innerHTML; // Use modified HTML
                const newCard = questionDisplayArea.querySelector('.question-card-loft');
                if (newCard) newCard.classList.add('entering');
                postRenderQuestionSetup();
            }
            
            if(progressInfoText) progressInfoText.textContent = `السؤال ${currentQuestionIndex + 1} من ${sessionQuestions.length}`;
            const progressPercent = sessionQuestions.length > 0 ? ((currentQuestionIndex + 1) / sessionQuestions.length) * 100 : 0;
            if(progressBarFill) progressBarFill.style.width = `${progressPercent}%`;
            if(progressBarFill.parentElement) progressBarFill.parentElement.setAttribute('aria-valuenow', Math.round(progressPercent));
        }

        function postRenderQuestionSetup() {
            if(nextBtn) {
                nextBtn.disabled = true; 
                if (currentQuestionIndex === sessionQuestions.length - 1) {
                    nextBtn.innerHTML = `إنهاء الاختبار <i class="fas fa-flag-checkered icon-after-text"></i>`;
                     nextBtn.setAttribute('aria-label', 'إنهاء الاختبار');
                } else {
                    nextBtn.innerHTML = `السؤال التالي <i class="fas fa-chevron-left icon-after-text"></i>`;
                    nextBtn.setAttribute('aria-label', 'السؤال التالي');
                }
            }

            if (prevBtn) {
                prevBtn.disabled = (currentQuestionIndex === 0);
            }

            const currentQId = sessionQuestions[currentQuestionIndex].id;
            const previousAnswerForThisQuestion = userAnswers.find(ans => ans.questionId === currentQId);
            if (previousAnswerForThisQuestion) {
                const escapedValue = previousAnswerForThisQuestion.userAnswerValue.replace(/"/g, '\\"');
                const optionInput = document.querySelector(`input[name="q_option"][value="${escapedValue}"]`);
                if (optionInput) {
                    optionInput.checked = true;
                    if(nextBtn) nextBtn.disabled = false; 
                }
            }
             // Update flag button text/state if it exists
            const flagButton = questionDisplayArea.querySelector('.flag-question-btn');
            if (flagButton) {
                const isFlagged = flaggedQuestions.includes(currentQId);
                flagButton.classList.toggle('flagged', isFlagged);
                flagButton.innerHTML = `<i class="fas fa-flag"></i> ${isFlagged ? 'إلغاء التعليم' : 'تعليم للمراجعة'}`;
                flagButton.setAttribute('aria-pressed', isFlagged);
            }
        }
        
        function toggleFlagQuestion(questionId) {
            const index = flaggedQuestions.indexOf(questionId);
            if (index > -1) {
                flaggedQuestions.splice(index, 1);
            } else {
                flaggedQuestions.push(questionId);
            }
            postRenderQuestionSetup(); // To update button appearance on current question
            renderQuestionNavPanel(); // To update nav panel
            saveCurrentExamState();
        }


        function renderQuestionNavPanel() {
            if (!qNavGridContainer || !sessionQuestions) return;
            qNavGridContainer.innerHTML = '';
            sessionQuestions.forEach((q, index) => {
                const item = document.createElement('button');
                item.classList.add('q-nav-item');
                item.textContent = index + 1;
                item.setAttribute('aria-label', `الانتقال إلى السؤال ${index + 1}`);
                
                const userAnswer = userAnswers.find(ans => ans.questionId === q.id);
                if (userAnswer) {
                    item.classList.add('answered');
                }
                if (flaggedQuestions.includes(q.id)) {
                    item.classList.add('flagged');
                }
                if (index === currentQuestionIndex) {
                    item.classList.add('current');
                    item.setAttribute('aria-current', 'true');
                }
                item.onclick = () => {
                    navigateToQuestion(index);
                    toggleQuestionNavModal(); // Close modal after navigation
                };
                qNavGridContainer.appendChild(item);
            });
        }

        function navigateToQuestion(index) {
            if (index >= 0 && index < sessionQuestions.length) {
                handleAnswerSelection(); // Save any answer before navigating away
                currentQuestionIndex = index;
                saveCurrentExamState();
                displayCurrentQuestion();
                renderQuestionNavPanel(); // Re-render to update current highlight
            }
        }

        function toggleQuestionNavModal() {
            if (questionNavModal.style.display === "block") {
                questionNavModal.style.display = "none";
            } else {
                renderQuestionNavPanel(); // Ensure it's up-to-date before showing
                questionNavModal.style.display = "block";
            }
        }


        function checkForOldResults() {
            if (viewLastResultsBtn) {
                try {
                    const savedResults = localStorage.getItem(LAST_RESULTS_KEY);
                    viewLastResultsBtn.disabled = !savedResults;
                } catch (e) {
                    console.error("Error checking localStorage:", e);
                    viewLastResultsBtn.disabled = true;
                }
            }
        }

        function viewLastResults() {
            stopTimer(); 
            landingPage.style.display = 'none';
            landingPage.style.animation = '';
            examPage.style.display = 'none';
            examPage.style.animation = '';
            if(oldResultsPage) oldResultsPage.style.display = 'none';

            try {
                const savedData = localStorage.getItem(LAST_RESULTS_KEY);
                if (!savedData) {
                    alert("لا توجد نتائج سابقة محفوظة.");
                    landingPage.style.display = 'block';
                    landingPage.style.animation = 'fadeInSlideUp 0.6s ease-out forwards';
                    return;
                }
                const lastResults = JSON.parse(savedData);
                
                let oldScoreIcon = '';
                if (lastResults.score === lastResults.totalQuestions) {
                    oldScoreContainer.style.backgroundColor = 'var(--success-color)';
                    oldScoreContainer.style.color = 'var(--text-on-primary-button)';
                    oldScoreIcon = '<i class="fas fa-trophy"></i>';
                } else if (lastResults.score >= lastResults.totalQuestions * 0.7) {
                    oldScoreContainer.style.backgroundColor = 'var(--success-color)';
                    oldScoreContainer.style.color = 'var(--text-on-primary-button)';
                    oldScoreIcon = '<i class="fas fa-check-circle"></i>';
                } else if (lastResults.score >= lastResults.totalQuestions * 0.4) {
                    oldScoreContainer.style.backgroundColor = 'var(--warning-color)';
                    oldScoreContainer.style.color = document.body.classList.contains('dark-theme') ? 'var(--app-bg-dark)' : 'var(--text-primary-light)';
                    oldScoreIcon = '<i class="fas fa-exclamation-circle"></i>';
                } else {
                    oldScoreContainer.style.backgroundColor = 'var(--danger-color)';
                    oldScoreContainer.style.color = 'var(--text-on-primary-button)';
                    oldScoreIcon = '<i class="fas fa-times-circle"></i>';
                }
                oldScoreContainer.innerHTML = `النتيجة السابقة (${lastResults.timestamp || ''}): ${lastResults.score} من ${lastResults.totalQuestions} ${oldScoreIcon}`;


                oldDetailedFeedbackContainer.innerHTML = '';
                if (lastResults.answers && Array.isArray(lastResults.answers) && lastResults.sessionQuestionIdsInOrder) {
                     lastResults.sessionQuestionIdsInOrder.forEach((qId, index) => {
                        const originalQuestionData = allQuestions.find(oq => oq.id === qId);
                        if (!originalQuestionData) return; // Skip if question not found in current allQuestions

                        const userAnswerData = lastResults.answers.find(ans => ans.questionId === qId);
                        
                        let isCorrect = false;
                        let userAnswerDisplay = "لم تتم الإجابة";
                        let correctAnswerForDisplay = originalQuestionData.type === "tf" ? (originalQuestionData.answer ? 'صحيح' : 'خطأ') : originalQuestionData.correctAnswerText;

                        if (userAnswerData) {
                            isCorrect = userAnswerData.isCorrect;
                            userAnswerDisplay = userAnswerData.userAnswerValue;
                             if (originalQuestionData.type === 'tf') {
                                userAnswerDisplay = (userAnswerData.userAnswerValue === 'true') ? 'صحيح' : 'خطأ';
                            }
                        }

                        const feedbackItem = document.createElement('div');
                        feedbackItem.classList.add('feedback-item', isCorrect ? 'correct' : 'incorrect');
                        
                        let explanationHTML = '';
                        if (originalQuestionData.explanation) {
                            explanationHTML = `<div class="explanation"><strong>توضيح:</strong> ${originalQuestionData.explanation}</div>`;
                        }

                        feedbackItem.innerHTML = `
                            <p><strong>السؤال ${index + 1}:</strong> ${originalQuestionData.text}</p>
                            <p class="user-answer">إجابتك: ${userAnswerDisplay}</p>
                            ${!isCorrect ? `<p>الإجابة الصحيحة: <span class="correct-answer-text">${correctAnswerForDisplay}</span></p>` : ''}
                            ${explanationHTML}
                        `;
                        oldDetailedFeedbackContainer.appendChild(feedbackItem);
                    });
                }


                if(oldResultsPage) {
                    oldResultsPage.style.display = 'block';
                    oldResultsPage.style.opacity = '0';
                    oldResultsPage.style.transform = 'translateY(20px)';
                    oldResultsPage.style.animation = 'fadeInSlideUp 0.5s ease-out forwards';
                }
            } catch (e) {
                console.error("Error displaying last results:", e);
                alert("حدث خطأ أثناء عرض النتائج السابقة.");
                landingPage.style.display = 'block';
                landingPage.style.animation = 'fadeInSlideUp 0.6s ease-out forwards';
            }
        }

        function closeOldResults() {
            if(oldResultsPage){
                oldResultsPage.style.animation = 'fadeOutSlideUp 0.4s ease-in forwards';
                 setTimeout(() => {
                    oldResultsPage.style.display = 'none';
                    oldResultsPage.style.animation = '';
                    landingPage.style.display = 'block';
                    landingPage.style.opacity = '0';
                    landingPage.style.transform = 'translateY(20px)';
                    landingPage.style.animation = 'fadeInSlideUp 0.6s ease-out forwards';
                    checkForOldResults();
                }, 400);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const preferredTheme = localStorage.getItem(THEME_KEY) || 'dark-theme';
            applyTheme(preferredTheme);

            if(totalQuestionsLandingSpan) {
                totalQuestionsLandingSpan.textContent = allQuestions.length;
            }
            if(examDurationLandingSpan) {
                examDurationLandingSpan.textContent = EXAM_DURATION_SECONDS / 60;
            }


            const stateRestored = loadAndRestoreExamState();
            
            if (!stateRestored) { 
                landingPage.style.display = 'block';
                landingPage.style.animation = 'fadeInSlideUp 0.6s ease-out forwards'; 
                if (examPage) examPage.style.display = 'none';
                if (oldResultsPage) oldResultsPage.style.display = 'none';
                if (resultsArea) resultsArea.style.display = 'none';
            }

            if(timerDisplay && timeLeftInSeconds === EXAM_DURATION_SECONDS) { 
                 updateTimerDisplay(); 
            }
            checkForOldResults();

            // Close modal if clicked outside content
            window.onclick = function(event) {
                if (event.target == questionNavModal) {
                    toggleQuestionNavModal();
                }
            }
        });

        window.addEventListener('beforeunload', () => {
            if (examPage.style.display === 'block' && 
                !(resultsArea.style.display === 'block' && resultsArea.classList.contains('visible')) &&
                timeLeftInSeconds > 0) {
                handleAnswerSelection(); // Ensure current selection is processed
                saveCurrentExamState();
            }
        });

    </script>
</body>
</html>
